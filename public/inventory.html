<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="view-transition" content="same-origin">
    <title>Inventario - Tomodachi</title>
    <!-- Local Fonts -->
    <link rel="stylesheet" href="css/fonts.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="lib/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/inventory.css">
    <script src="js/theme-init.js"></script>
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="sidebar-close" id="sidebarClose" aria-label="Cerrar menú"><i class="fas fa-times"></i></button>
                <h2>Tomodachi</h2>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span><i class="fas fa-chart-line"></i></span> Dashboard
                </a>
                <a href="sales.html" class="nav-item">
                    <span><i class="fas fa-cash-register"></i></span> Punto de Venta
                </a>
                <a href="inventory.html" class="nav-item active">
                    <span><i class="fas fa-box"></i></span> Inventario
                </a>
                <a href="finance.html" class="nav-item">
                    <span><i class="fas fa-wallet"></i></span> Finanzas
                </a>
                <a href="reports.html" class="nav-item desktop-only-nav">
                    <span><i class="fas fa-chart-bar"></i></span> Reportes
                </a>
                
                <div class="nav-group profile-nav-group">
                    <a href="profile.html" class="nav-item" id="profileMenuBtn">
                        <span class="profile-icon-container">
                            <img src="assets/images/default-logo.png" alt="Store" class="nav-profile-img" id="navStoreLogo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block'">
                            <i class="fas fa-circle-user" style="display:none; font-size: 1.5rem;"></i>
                        </span>
                        <span class="nav-text">Mi Perfil</span>
                    </a>
                    
                    <div class="user-tooltip-menu" id="profileTooltipMenu">
                        <a href="profile.html" class="tooltip-item">
                            <i class="fas fa-cog"></i> Configuración
                        </a>
                        <a href="reports.html" class="tooltip-item">
                            <i class="fas fa-chart-bar"></i> Reportes
                        </a>
                        <a href="#" class="tooltip-item js-support-btn">
                            <i class="fas fa-headset"></i> Soporte
                        </a>
                        <a href="#" class="tooltip-item" onclick="logout(); return false;">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </a>
                    </div>
                </div>
                <a href="#" class="nav-item" id="logoutBtn">
                    <span><i class="fas fa-sign-out-alt"></i></span> Cerrar Sesión
                </a>
                
                <div class="nav-separator" style="margin: 10px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
                
                <a href="#" class="nav-item desktop-only-nav js-support-btn" id="supportBtn" style="color: #aaa; font-size: 0.9em;">
                    <span><i class="fas fa-headset"></i></span> Soporte / Sugerencias
                </a>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            
            <div class="inventory-container">
                <!-- Panel de búsqueda y controles -->
                <section class="inv-controls">
                    <div class="controls-top">
                        <div class="search-section">
                            <div class="search-header">
                                <h3><i class="fas fa-magnifying-glass"></i> Buscar Productos</h3>
                            </div>
                        <div class="search-bar">
                            <div class="search-input-wrapper">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="searchInput" placeholder="Nombre, código, SKU..." aria-label="Buscar productos" class="search-input">
                                <button id="toggleScannerBtn" type="button" class="btn-scanner-icon" title="Escanear código de barras" style="background: var(--primary-color); border: none; cursor: pointer; color: white; padding:5px; border-radius: 3px;  margin-right: 5px;">
                                    <i class="fas fa-barcode" style="font-size: 1.2rem;"></i>
                                </button>
                                <span class="search-hint" title="Busca mientras escribes o escanea un código de barras">
                                    <i class="fas fa-circle-info"></i>
                                    <span class="hint-text">Escribe nombre, código o escanea QR/código de barras</span>
                                </span>
                                <span class="search-loading" id="searchLoading" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </div>
                            <div id="scannerContainer" class="scanner-container hidden" style="margin-top: 10px;">
                                <div id="qr-reader" style="width:100%;"></div>
                            </div>
                        </div>
                        <div class="search-info" id="searchInfo" style="display: none;">
                            <span id="searchResultCount"></span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="manageCategoriesBtn" class="btn-secondary" title="Gestionar Categorías" style="white-space: nowrap;">
                            <i class="fas fa-tags"></i> Categorías
                        </button>
                        <button type="button" id="addProductBtn" class="btn-add-product" title="Agregar nuevo producto">
                            <i class="fas fa-plus"></i> Nuevo Producto
                        </button>
                    </div>
                    
                    <div class="image-upload" style="display: none;">
                        <div class="upload-header">
                            <h3><i class="fas fa-image"></i> Subir Imagen</h3>
                        </div>
                        <div class="upload-controls">
                            <input type="number" id="productId" placeholder="ID del producto" aria-label="ID Producto" class="input-id">
                            <label class="file-label" for="productImage" title="Seleccionar imagen"><i class="fas fa-image"></i></label>
                            <input type="file" id="productImage" accept="image/png,image/jpeg" class="hidden" aria-label="Seleccionar imagen">
                            <button type="button" id="uploadImageBtn" class="btn-primary" aria-label="Subir imagen"><i class="fas fa-upload"></i> Subir</button>
                        </div>
                    </div>
                </section>

                <!-- Lista de productos -->
                <section class="inv-products products-main">
                    <div id="uploadPreview"></div>
                    <div id="invResults" class="products-grid"></div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Modal para agregar producto -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Agregar Nuevo Producto</h2>
                <button type="button" class="modal-close" id="closeModalBtn" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addProductForm" class="modal-body">
                <div class="form-group">
                    <label for="productNameInput">Nombre del Producto <span class="required">*</span></label>
                    <input type="text" id="productNameInput" name="product_name" placeholder="Ej: Televisor 50 pulgadas" required>
                </div>
                
                <div class="form-group">
                    <label for="productDescInput">Descripción</label>
                    <textarea id="productDescInput" name="description" placeholder="Describe el producto..." rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Imagen del Producto</label>
                    <div class="image-input-wrapper" style="display: flex; align-items: center; gap: 15px;">
                        <label for="addProductImage" class="btn-secondary" style="cursor: pointer; padding: 8px 15px; border-radius: 4px; background: #e0e0e0;">
                            <i class="fas fa-camera"></i> Seleccionar
                        </label>
                        <button type="button" class="btn-secondary" onclick="openAIModal('add')" style="display: none; padding: 8px 15px; border-radius: 4px; background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; cursor: pointer;">
                            <i class="fas fa-wand-magic-sparkles"></i> Crear con IA
                        </button>
                        <input type="file" id="addProductImage" accept="image/*" style="display: none;">
                        <div id="addProductImagePreview" style="width: 50px; height: 50px; border-radius: 4px; overflow: hidden; display: none; border: 1px solid #ddd;">
                            <img src="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <span id="addProductImageName" style="font-size: 0.9em; color: #666;"></span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productCategoryInput">Categoría</label>
                        <select id="productCategoryInput" name="category_id">
                            <option value="">Seleccionar categoría...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productSkuInput">SKU/Código</label>
                        <input type="text" id="productSkuInput" name="sku" placeholder="Ej: SKU12345">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productBarcodeInput">Código de Barras</label>
                        <input type="text" id="productBarcodeInput" name="barcode" placeholder="Escanea o ingresa">
                    </div>
                    <div class="form-group">
                        <label for="productQRInput">Código QR</label>
                        <input type="text" id="productQRInput" name="qr_code" placeholder="Escanea o ingresa">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productCostInput">Costo (Compra)</label>
                        <input type="number" id="productCostInput" name="cost" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="productPriceInput">Precio (Venta) <span class="required">*</span></label>
                        <input type="number" id="productPriceInput" name="price" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productStockInput">Stock Inicial <span class="required">*</span></label>
                        <input type="number" id="productStockInput" name="stock" placeholder="0" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productMinStockInput">Stock Mínimo</label>
                        <input type="number" id="productMinStockInput" name="min_stock" placeholder="5" min="0" value="5">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancelProductBtn">Cancelar</button>
                    <button type="submit" class="btn-save">Agregar Producto</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Drawer para Detalles/Edición de Producto -->
    <div id="productDetailsModal" class="drawer-overlay">
        <div class="drawer-content">
            <div class="drawer-header">
                <h2><i class="fas fa-edit"></i> Detalles del Producto</h2>
                <button type="button" class="drawer-close" id="closeDetailsModalBtn" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="drawer-body">
                <form id="editProductForm" class="drawer-form">
                    <input type="hidden" id="editProductId" name="product_id">

                    <!-- Tarjeta de Imagen -->
                    <div class="details-card">
                        <div class="card-body" style="padding: 0;">
                            <div class="product-image-container large-preview">
                                <img id="detailImage" src="" alt="Producto" class="detail-img">
                                <div class="image-overlay">
                                    <label for="detailImageInput" class="btn-change-image"><i class="fas fa-camera"></i> Cambiar Imagen</label>
                                    <button type="button" class="btn-change-image" onclick="openAIModal('edit')" style="display: none; margin-top: 5px; background: rgba(255,255,255,0.9); color: var(--primary-color); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: 500;">
                                        <i class="fas fa-wand-magic-sparkles"></i> Mejorar con IA
                                    </button>
                                    <input type="file" id="detailImageInput" accept="image/*" class="hidden">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tarjeta Análisis de Ganancia -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> Análisis de Ganancia</h3>
                        </div>
                        <div class="card-body">
                            <div class="profit-grid">
                                <div class="profit-item">
                                    <span class="label">Precio Venta</span>
                                    <span id="detailPriceDisplay" class="value">$0.00</span>
                                </div>
                                <div class="profit-item">
                                    <span class="label">Costo Compra</span>
                                    <span id="detailCostDisplay" class="value">$0.00</span>
                                </div>
                                <div class="profit-item highlight">
                                    <span class="label">Ganancia</span>
                                    <span id="detailProfitDisplay" class="value profit-positive">$0.00</span>
                                </div>
                                <div class="profit-item">
                                    <span class="label">Margen</span>
                                    <span id="detailMarginDisplay" class="value">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tarjeta Información General -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3><i class="fas fa-info-circle"></i> Información General</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="editProductName">Nombre del Producto</label>
                                <input type="text" id="editProductName" name="product_name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="editProductDesc">Descripción</label>
                                <textarea id="editProductDesc" name="description" rows="2"></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProductCategory">Categoría</label>
                                    <select id="editProductCategory" name="category_id">
                                        <option value="">Sin categoría</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editProductStatus">Estado</label>
                                    <select id="editProductStatus" name="status">
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tarjeta Códigos -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3><i class="fas fa-barcode"></i> Códigos de Identificación</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProductBarcode">Código de Barras</label>
                                    <input type="text" id="editProductBarcode" name="barcode">
                                </div>
                                <div class="form-group">
                                    <label for="editProductQR">Código QR</label>
                                    <input type="text" id="editProductQR" name="qr_code">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tarjeta Precios e Inventario -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3><i class="fas fa-tags"></i> Precios e Inventario</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProductCost">Costo (Compra)</label>
                                    <input type="number" id="editProductCost" name="cost" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="editProductPrice">Precio (Venta)</label>
                                    <input type="number" id="editProductPrice" name="price" step="0.01" min="0" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProductStock">Stock Actual</label>
                                    <input type="number" id="editProductStock" name="current_stock" >
                                </div>
                                <div class="form-group">
                                    <label for="editProductMinStock">Stock Mínimo</label>
                                    <input type="number" id="editProductMinStock" name="min_stock" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions-centered">
                        <button type="button" class="btn-danger" id="deleteProductBtn" style="display: none;">Eliminar</button>
                        <button type="button" class="btn-cancel" id="cancelEditBtn">Cancelar</button>
                        <button type="submit" class="btn-save">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal para gestionar categorías -->
    <div id="categoriesModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-tags"></i> Gestionar Categorías</h2>
                <button type="button" class="modal-close" id="closeCategoriesModalBtn" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <div class="form-group">
                        <label for="newCategoryName">Nombre de la Categoría</label>
                        <input type="text" id="newCategoryName" placeholder="Ej: Bebidas" required style="width: 100%;">
                    </div>

                    <div class="form-group">
                        <label>Seleccionar Icono</label>
                        <input type="hidden" id="newCategoryIcon">
                        <div class="icon-picker-box">
                            <div class="icon-picker-header">
                                <div id="iconPreviewContainer" class="icon-preview-large hidden">
                                    <i id="iconPreviewIcon" class="fas fa-tag"></i>
                                </div>
                                <div class="icon-picker-search-row" style="flex: 1;">
                                    <input type="text" id="newCategoryIconSearch" class="form-control" placeholder="Buscar icono (es/en)..." aria-label="Buscar icono">
                                    <span class="icon-picked" id="newCategoryIconSelected">Ninguno seleccionado</span>
                                </div>
                            </div>
                            <div id="newCategoryIconList" class="icon-options-grid" aria-label="Opciones de iconos"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn-save" style="width: 100%;">
                        <i class="fas fa-plus"></i> Agregar Categoría
                    </button>
                </form>
                
                <div class="categories-list-container">
                    <h3>Categorías Existentes</h3>
                    <ul id="categoriesList" class="simple-list" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto;">
                        <!-- Items injected by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal IA Enhancer -->
    <div id="aiModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-wand-magic-sparkles"></i> Estudio Fotográfico IA</h2>
                <button class="close-modal" onclick="closeAIModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ai-workspace">
                    <div class="ai-column source-column">
                        <h3>1. Imagen Original</h3>
                        <div class="image-upload-area" id="aiUploadArea" onclick="document.getElementById('aiImageInput').click()">
                            <img id="aiOriginalPreview" src="" alt="Vista previa" style="display:none; max-width: 100%; max-height: 250px; border-radius: 8px;">
                            <div class="upload-placeholder" id="aiUploadPlaceholder">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Arrastra o selecciona una foto</p>
                            </div>
                            <input type="file" id="aiImageInput" accept="image/*" hidden>
                        </div>
                        <button class="btn-secondary" onclick="document.getElementById('aiImageInput').click()" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-camera"></i> Subir / Tomar Foto
                        </button>
                    </div>

                    <div class="ai-column settings-column">
                        <h3>2. Configuración IA</h3>
                        
                        <div class="ai-tabs" style="display: flex; gap: 5px; margin-bottom: 15px; background: #eee; padding: 4px; border-radius: 8px;">
                            <button class="ai-tab active" onclick="switchAIMode('enhance')" style="flex: 1; border: none; background: white; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Mejorar</button>
                            <button class="ai-tab" onclick="switchAIMode('studio')" style="flex: 1; border: none; background: transparent; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; color: #666;">Estudio</button>
                        </div>

                        <!-- MODO MEJORAR (Original) -->
                        <div id="modeEnhance" class="ai-mode-content">
                            <div class="form-group">
                                <label>Análisis Automático (Gemini)</label>
                                <div id="aiAnalysisStatus" class="status-badge status-waiting">Esperando imagen...</div>
                            </div>

                            <div class="form-group">
                                <label for="aiPrompt">Prompt (Instrucciones para la IA)</label>
                                <textarea id="aiPrompt" class="form-control" rows="4" placeholder="Describe cómo quieres que se vea la imagen..."></textarea>
                                <small class="text-muted">Puedes editar la sugerencia de la IA.</small>
                            </div>

                            <div class="form-group">
                                <label>Nivel de Creatividad IA:</label>
                                <div class="strength-controls">
                                    <button type="button" class="btn-strength" data-value="0.75" onclick="selectStrength(this)">
                                        <i class="fas fa-feather"></i> Sutil
                                    </button>
                                    <button type="button" class="btn-strength active" data-value="0.55" onclick="selectStrength(this)">
                                        <i class="fas fa-magic"></i> Moderado
                                    </button>
                                    <button type="button" class="btn-strength" data-value="0.25" onclick="selectStrength(this)">
                                        <i class="fas fa-bolt"></i> Alto
                                    </button>
                                </div>
                                <input type="hidden" id="aiStrength" value="0.55">
                                <small class="text-muted" id="strengthDesc">Mejora la calidad manteniendo la forma original.</small>
                            </div>

                            <button id="btnGenerateAI" class="btn-primary" onclick="generateAIImage()" disabled style="width: 100%; margin-top: 20px;">
                                <i class="fas fa-magic"></i> Generar Versión Pro
                            </button>
                        </div>

                        <!-- MODO ESTUDIO (Nuevo) -->
                        <div id="modeStudio" class="ai-mode-content" style="display:none;">
                            <div class="form-group">
                                <label>Tipo de Fondo</label>
                                <select id="studioBgType" class="form-control" onchange="toggleStudioOptions()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                                    <option value="generate">Generar Escenario (IA)</option>
                                    <option value="white">Fondo Blanco / Transparente</option>
                                </select>
                            </div>

                            <!-- Opciones Generar -->
                            <div id="studioGenerateOptions">
                                <div class="form-group">
                                    <label>Prompt del Escenario</label>
                                    <textarea id="studioPrompt" class="form-control" rows="3" placeholder="Ej: Mesa de madera rústica, luz natural, desenfoque..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <button class="btn-secondary" onclick="generateBackgroundPreview()" style="width:100%; margin-bottom:10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        <i class="fas fa-image"></i> Generar Solo Fondo
                                    </button>
                                    <div id="bgPreviewArea" style="display:none; margin-bottom:10px; position:relative; border: 2px dashed #ddd; padding: 5px; border-radius: 8px;">
                                        <img id="bgPreviewImg" src="" style="width:100%; border-radius:6px; display: block;">
                                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                                            <button class="btn-sm btn-success" onclick="saveBackgroundToLibrary()" style="flex: 1;">
                                                <i class="fas fa-save"></i> Guardar
                                            </button>
                                            <button class="btn-sm btn-danger" onclick="clearBackgroundPreview()" style="flex: 0 0 auto;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button id="btnGenerateStudio" class="btn-primary" onclick="generateStudioImage()" disabled style="width: 100%; margin-top: 20px;">
                                <i class="fas fa-layer-group"></i> Aplicar Fondo
                            </button>
                        </div>
                    </div>

                    <div class="ai-column result-column">
                        <h3>3. Resultado y Comparación</h3>
                        
                        <div class="result-preview-area" id="resultContainer">
                            <!-- Estado Inicial -->
                            <div id="aiEmptyResult" class="text-muted" style="text-align: center; padding: 40px;">
                                <i class="fas fa-image fa-3x" style="opacity: 0.3;"></i>
                                <p>Aquí aparecerá tu imagen mejorada</p>
                            </div>

                            <!-- Loading -->
                            <div id="aiLoading" style="display:none; text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary-color);"></i>
                                <p style="margin-top: 15px;">La IA está trabajando...</p>
                            </div>

                            <!-- Comparador -->
                            <div id="aiComparison" class="comparison-container" style="display:none;">
                                <div class="comparison-view">
                                    <img id="compOriginal" src="" class="comp-img original">
                                    <img id="compResult" src="" class="comp-img result" style="opacity: 0;">
                                    
                                    <!-- Slider Handle (Solo Desktop) -->
                                    <div class="slider-handle"></div>
                                </div>
                                
                                <div class="comparison-controls">
                                    <span class="comp-label">Original</span>
                                    <input type="range" min="0" max="100" value="0" class="fade-slider" oninput="updateComparison(this.value)">
                                    <span class="comp-label">IA Pro</span>
                                </div>
                                <div class="mobile-hint"><i class="fas fa-arrows-alt-h"></i> Desliza para comparar</div>
                            </div>
                        </div>
                        
                        <div id="aiActions" style="display:none; margin-top: 15px;">
                            <button class="btn-success" onclick="applyAIImage()" style="width: 100%; margin-bottom: 10px;">
                                <i class="fas fa-check"></i> Usar esta Imagen
                            </button>
                            <div class="ai-suggestions">
                                <label>Sugerencia de Descripción:</label>
                                <p id="aiDescriptionSuggestion" style="font-size: 0.9em; font-style: italic; color: #666; background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 5px;"></p>
                                <button class="btn-secondary btn-sm" onclick="copyAIDescription()" style="margin-top: 5px; width: 100%;">Copiar Descripción</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/app.js"></script>
    <script src="lib/html5-qrcode/html5-qrcode.min.js"></script>
    <script src="js/scanner.js"></script>
    <script src="js/tour.js"></script>
    <script src="js/inventory.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const session = await checkSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            
            // Iniciar Tour
            if (window.TourSystem) {
                window.TourSystem.init(session);
            }

            const userNameEl = document.getElementById('userName');
            const userRoleEl = document.getElementById('userRole');

            if (userNameEl) userNameEl.textContent = session.full_name || '';
            if (userRoleEl) userRoleEl.textContent = (session.role || '').toUpperCase();
        });

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await logout();
            });
        }
    </script>
<style>
    /* Estilos para el Estudio IA */
    .strength-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
    }
    .btn-strength {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        background: #f8f9fa;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        font-size: 0.9em;
    }
    .btn-strength i { font-size: 1.2em; color: #666; }
    .btn-strength.active {
        background: #e3f2fd;
        border-color: #2196f3;
        color: #1976d2;
        font-weight: bold;
    }
    .btn-strength.active i { color: #1976d2; }

    /* Comparador de Imágenes */
    .comparison-container {
        width: 100%;
        max-width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .comparison-view {
        position: relative;
        width: 100%;
        height: 300px; /* Altura fija para el comparador */
        overflow: hidden;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        background: #f0f0f0;
    }
    .comp-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain; /* Ajustar imagen sin cortar */
        transition: opacity 0.1s ease;
    }
    .comp-img.result {
        z-index: 2;
    }
    
    .comparison-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 0 10px;
    }
    .fade-slider {
        flex: 1;
        height: 6px;
        -webkit-appearance: none;
        background: #ddd;
        border-radius: 3px;
        outline: none;
    }
    .fade-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .comp-label {
        font-size: 0.85em;
        font-weight: bold;
        color: #555;
        width: 60px;
        text-align: center;
    }
    .mobile-hint {
        text-align: center;
        font-size: 0.8em;
        color: #999;
        margin-top: -5px;
    }
</style>
</body>
</html>
