<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="view-transition" content="same-origin">
    <title>Punto de Venta - Tomodachi POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/sales.css">
    <link rel="stylesheet" href="css/scanner_overlay.css">
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="app-container">
                <!-- Sidebar -->
                <aside class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <button class="sidebar-close" id="sidebarClose" aria-label="Cerrar menú"><i class="fas fa-times"></i></button>
                        <h2>Tomodachi POS</h2>
                    </div>
                    <nav class="sidebar-nav">
                        <a href="dashboard.html" class="nav-item">
                            <span><i class="fas fa-chart-line"></i></span> Dashboard
                        </a>
                        <a href="sales.html" class="nav-item active">
                            <span><i class="fas fa-cash-register"></i></span> Punto de Venta
                        </a>
                        <a href="inventory.html" class="nav-item">
                            <span><i class="fas fa-box"></i></span> Inventario
                        </a>
                        <div class="nav-group user-nav-group">
                            <button class="nav-item nav-item-btn" id="userMenuBtn">
                                <span><i class="fas fa-user-circle"></i></span> Usuario
                            </button>
                            <div class="user-tooltip-menu" id="userTooltipMenu">
                                <a href="#" class="tooltip-item" onclick="showProfileSettings(); return false;">
                                    <i class="fas fa-cog"></i> Mi Perfil
                                </a>
                                <a href="reports.html" class="tooltip-item">
                                    <i class="fas fa-chart-bar"></i> Reportes
                                </a>
                                <a href="#" class="tooltip-item" onclick="logout(); return false;">
                                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                </a>
                            </div>
                        </div>
                        <a href="#" class="nav-item" id="logoutBtn">
                            <span><i class="fas fa-sign-out-alt"></i></span> Cerrar Sesión
                        </a>
                    </nav>
                </aside>

                <!-- Main Content -->
                <main class="main-content">
                    <div class="pos-container">
                        <!-- Encabezado con búsqueda -->
                        <div class="pos-header">
                            <div class="search-section">
                                <input type="text" id="searchInput" placeholder="Buscar producto..." autocomplete="off" aria-label="Buscar producto" class="search-main">
                                <button id="toggleScannerBtn" type="button" class="btn-scanner" aria-label="Escáner" title="Activar escáner"><i class="fas fa-barcode"></i></button>
                            </div>
                            
                            <!-- Checkout Header (Movido desde abajo) -->
                            <div class="cart-footer checkout-header">
                                <div class="checkout-group" role="group" aria-label="Resumen y pago">
                                    <div class="checkout-item total-item" aria-label="Total a pagar">
                                        <div class="checkout-label"><i class="fas fa-sack-dollar" aria-hidden="true"></i><span>Total</span></div>
                                        <span id="totalBadge" class="checkout-value total-value" aria-live="polite">$0.00</span>
                                    </div>
                                    <div class="checkout-item received-item" aria-label="Monto recibido">
                                        <div class="checkout-label"><i class="fas fa-hand-holding-dollar" aria-hidden="true"></i><span>Recibido</span></div>
                                        <input type="number" id="checkoutReceived" min="0" step="0.01" value="0" class="checkout-input" placeholder="0.00" aria-label="Ingresar monto recibido">
                                    </div>
                                    <div class="checkout-item change-item" aria-label="Cambio a entregar">
                                        <div class="checkout-label"><i class="fas fa-coins" aria-hidden="true"></i><span>Cambio</span></div>
                                        <span id="checkoutChange" class="checkout-value change-value" aria-live="polite">$0.00</span>
                                    </div>
                                    <button id="finalizeSaleBtn" class="btn-finalize-sale" disabled title="Finalizar venta" aria-label="Finalizar venta"><i class="fas fa-check"></i><span class="btn-text">Finalizar</span></button>
                                </div>
                            </div>

                            <div id="scannerContainer" class="scanner-container hidden">
                                <div id="qr-reader" style="width:100%;"></div>
                            </div>
                        </div>

                        <!-- Galería de productos principal -->
                        <div class="products-main">
                            <div id="searchResults" class="search-results hidden"></div>
                            <div id="productGallery" class="gallery-main"></div>
                        </div>

                        <!-- Footer fijo inferior: checkout (ELIMINADO) -->

                        <!-- Asa y panel lateral del carrito (oculto por defecto) -->
                        <button id="cartHandle" class="cart-handle" aria-label="Abrir carrito">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cartCountBadge" class="cart-badge" style="display: none;">0</span>
                        </button>
                        <aside class="cart-side-panel" id="cartPanel" aria-label="Carrito de compras" aria-hidden="true">
                            <div class="cart-side-header">
                                <h2>Carrito</h2>
                                <button class="close-cart" id="closeCartBtn" aria-label="Cerrar carrito"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="cart-tabs">
                                <button class="cart-tab-btn active" data-tab="products">
                                    <span><i class="fas fa-shopping-bag"></i></span> Productos
                                </button>
                                <button class="cart-tab-btn" data-tab="adjustments">
                                    <span><i class="fas fa-cog"></i></span> Ajustes
                                </button>
                            </div>
                            <!-- Tab: Productos -->
                            <div class="cart-tab-content active" id="tab-products">
                                <div class="cart-items">
                                    <table class="cart-table">
                                        <thead>
                                            <tr>
                                                <th>Info</th> <!-- Cambiado para incluir img + nombre -->
                                                <th>Precio</th>
                                                <th>Cant.</th>
                                                <th>Acciones</th> <!-- Espacio para editar y borrar -->
                                            </tr>
                                        </thead>
                                        <tbody id="cartBody"></tbody>
                                    </table>
                                    <div class="empty-cart" id="emptyCartMsg">Sin productos</div>
                                </div>
                            </div>
                            <!-- Tab: Ajustes -->
                            <div class="cart-tab-content" id="tab-adjustments">
                                <div class="adjustments-section">
                                    <div class="adjustments-row">
                                        <div class="adjustment-item">
                                            <label>Descuento:</label>
                                            <input type="number" id="discountInput" min="0" step="0.01" value="0" placeholder="0.00" class="compact-input">
                                        </div>
                                        <div class="adjustment-item">
                                            <label>Impuesto:</label>
                                            <input type="number" id="taxInput" min="0" step="0.01" value="0" placeholder="0.00" class="compact-input">
                                        </div>
                                    </div>
                                    <div class="payment-section">
                                        <label>Método de pago:</label>
                                        <select id="paymentMethod" aria-label="Método de pago">
                                            <option value="cash">Efectivo</option>
                                            <option value="card">Tarjeta</option>
                                            <option value="transfer">Transferencia</option>
                                            <option value="mixed">Mixto</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="cart-side-footer">
                                <span>Total</span>
                                <strong id="panelTotal">$0.00</strong>
                            </div>
                        </aside>
                    </div>
                </main>
            </div>

            <!-- Modal para Opciones de Producto (Descuentos y Promociones) -->
    <div id="itemOptionsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalProductName">Editar Producto</h3>
                <button class="modal-close" id="closeItemModalBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="current-price-info">
                    <p>Precio Original: <span id="modalOriginalPrice">$0.00</span></p>
                </div>
                
                <div class="discount-type-selector">
                    <label>Tipo de Ajuste:</label>
                    <select id="discountTypeSelect">
                        <option value="none">Sin descuento</option>
                        <option value="percent">Porcentaje (%)</option>
                        <option value="fixed">Descuento Fijo ($)</option>
                        <option value="nxn">Promoción NxN</option>
                    </select>
                </div>

                <!-- Opciones dinámicas -->
                <div id="opt-percent" class="discount-option hidden">
                    <label>Porcentaje de descuento:</label>
                    <div class="input-group">
                        <input type="number" id="discPercentInput" min="0" max="100" placeholder="Ej: 10">
                        <span>%</span>
                    </div>
                </div>

                <div id="opt-fixed" class="discount-option hidden">
                    <label>Monto a descontar:</label>
                    <div class="input-group">
                        <span>$</span>
                        <input type="number" id="discFixedInput" min="0" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div id="opt-nxn" class="discount-option hidden">
                    <label>Configuración NxN:</label>
                    <div class="nxn-group">
                        <div class="nxn-item">
                            <small>Lleva</small>
                            <input type="number" id="nxnBuyInput" min="1" placeholder="Ej: 2">
                        </div>
                        <div class="nxn-item">
                            <small>Paga</small>
                            <input type="number" id="nxnPayInput" min="0" placeholder="Ej: 1">
                        </div>
                    </div>
                    <p class="hint-text">Ejemplo: 2x1 (Lleva 2, Paga 1)</p>
                </div>

                <div class="final-price-preview">
                    <p>Nuevo Precio Unitario: <strong id="modalNewPrice">$0.00</strong></p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveItemOptionsBtn" class="btn-primary">Aplicar Cambios</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="js/scanner.js"></script>
    <script src="js/sales.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const session = await checkSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            document.body.setAttribute('data-store-id', session.store_id || 1);
            initPOS();
        });
        (function(){
            const logoutEl = document.getElementById('logoutBtn');
            if (logoutEl) {
                logoutEl.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await logout();
                });
            }
        })();
    </script>
</body>
</html>
